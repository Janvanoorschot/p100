#!/usr/bin/env python3

import sys
import os
import time
import argparse
import datetime

rootdir = os.path.abspath(os.path.join(os.path.dirname(__file__), os.pardir))
sys.path.append(rootdir)


class LoadFromFile (argparse.Action):
    def __call__ (self, parser, namespace, values, option_string = None):
        with values as f:
            # parse arguments in the file and store them in the target namespace
            parser.parse_args(f.read().split(), namespace)


def main(args):
    # Create the P110 session
    from PyP100 import PyP110
    p110 = PyP110.P110(args.ip, args.username, args.password)
    p110.handshake()
    p110.login()

    # Create the database session
    from p100 import P110DBase
    db = P110DBase(args.dbase)

    # do the loop thingie
    while True:
        timestamp = datetime.datetime.now()
        info = p110.getDeviceInfo()
        usage = p110.getEnergyUsage()
        db.record(timestamp, info, usage)
        time.sleep(args.sleep)


if __name__ == "__main__":
    parser = argparse.ArgumentParser(description='P110 Monitor Service.')
    parser.add_argument('--ip', type=str, default='192.168.2.2', help='P110 plug')
    parser.add_argument('--username', type=str, default='some@one.com', help='username')
    parser.add_argument('--password', type=str, default='secret', help='password')
    parser.add_argument('--dbase', type=str, default='/opt/p100/dbases/p110mon.db', help='SQL Lite database file')
    parser.add_argument('--sleep', type=int, default=60, help='Time between samples')
    parser.add_argument('--file', type=open, action=LoadFromFile)
    args = parser.parse_args()
    main(args)




